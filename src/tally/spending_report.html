<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spending Report</title>
    <style>/* CSS_PLACEHOLDER */</style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Header -->
            <header>
                <h1>{{ title }}</h1>
                <p class="subtitle">{{ subtitle }}</p>
                <button class="theme-toggle" @click="toggleTheme" :title="isDarkTheme ? 'Switch to light mode' : 'Switch to dark mode'">
                    {{ isDarkTheme ? '‚òÄÔ∏è' : 'üåô' }}
                </button>
            </header>

            <!-- Search & Filters -->
            <div class="search-box" :class="{ scrolled: isScrolled }">
                <div class="autocomplete-container">
                    <input type="text"
                           v-model="searchQuery"
                           @input="onSearchInput"
                           @focus="showAutocomplete = true"
                           @keydown="onSearchKeydown"
                           placeholder="Search merchants, categories, locations...">
                    <div class="autocomplete-list" :class="{ show: showAutocomplete && filteredAutocomplete.length > 0 }">
                        <div v-for="(item, index) in filteredAutocomplete"
                             :key="item.id"
                             class="autocomplete-item"
                             :class="{ selected: index === autocompleteIndex }"
                             @click="selectAutocompleteItem(item)">
                            {{ item.displayText }}
                            <span class="type" :class="item.type">{{ item.type }}</span>
                        </div>
                    </div>
                </div>
                <select class="date-range-select" @change="addMonthFilter($event.target.value); $event.target.value = ''">
                    <option value="">+ Date filter</option>
                    <optgroup label="Individual Months">
                        <option v-for="m in availableMonths" :key="m.key" :value="m.key">{{ m.label }}</option>
                    </optgroup>
                </select>
                <div class="filter-chips" v-if="activeFilters.length > 0">
                    <div v-for="(filter, index) in activeFilters"
                         :key="index"
                         class="filter-chip"
                         :class="[filter.type, filter.mode]"
                         @click="toggleFilterMode(index)">
                        <span class="chip-type">{{ filterTypeChar(filter.type) }}</span>
                        <span class="chip-text">{{ filter.displayText || filter.text }}</span>
                        <span class="chip-remove" @click.stop="removeFilter(index)">&times;</span>
                    </div>
                    <button v-if="activeFilters.length > 1" class="clear-all-btn" @click="clearFilters">Clear all</button>
                </div>
            </div>

            <!-- Help Section -->
            <div class="help-section" :class="{ collapsed: helpCollapsed }">
                <div class="help-section-header" @click="helpCollapsed = !helpCollapsed">
                    <h3>How to Read This Report</h3>
                    <span class="toggle">{{ helpCollapsed ? '‚ñ∂' : '‚ñº' }}</span>
                </div>
                <div class="help-section-content">
                    <span class="label">Categories:</span>
                    <span class="value">Merchants are grouped by their assigned category from merchant_categories.csv</span>
                    <span class="label">Terms:</span>
                    <span class="value"><code>YTD</code> year-to-date total ¬∑ <code>Count</code> number of transactions</span>
                    <span class="label">Filters:</span>
                    <span class="value">Click on categories, tags, or locations to filter. Use search to find specific merchants.</span>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="card total">
                    <h2>Total Spending (YTD)</h2>
                    <div class="amount">{{ formatCurrency(grandTotal) }}</div>
                    <div class="breakdown">
                        <div class="breakdown-item">
                            <span class="name">Uncategorized</span>
                            <span class="value">{{ formatCurrency(uncategorizedTotal) }} ({{ formatPct(uncategorizedTotal, grandTotal) }})</span>
                        </div>
                    </div>
                </div>
                <div class="card cashflow" v-if="incomeCount > 0 || transfersCount > 0">
                    <h2>Cash Flow</h2>
                    <div class="amount" :class="{ positive: netCashFlow >= 0, negative: netCashFlow < 0 }">
                        {{ netCashFlow >= 0 ? '+' : '' }}{{ formatCurrency(netCashFlow) }}
                    </div>
                    <div class="breakdown">
                        <div class="breakdown-item clickable" v-if="incomeCount > 0" @click="scrollToIncome">
                            <span class="name income-label">Income</span>
                            <span class="value">+{{ formatCurrency(Math.abs(incomeTotal)) }}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="name">Spending</span>
                            <span class="value">-{{ formatCurrency(grandTotal) }}</span>
                        </div>
                        <div class="breakdown-item clickable" v-if="transfersCount > 0" @click="scrollToTransfers">
                            <span class="name transfers-label">Transfers</span>
                            <span class="value">-{{ formatCurrency(transfersTotal) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="chart-section">
                <div class="section-header" @click="chartsCollapsed = !chartsCollapsed">
                    <h2>
                        <span class="toggle">{{ chartsCollapsed ? '‚ñ∂' : '‚ñº' }}</span>
                        Spending Trends
                    </h2>
                </div>
                <div class="section-content" :class="{ collapsed: chartsCollapsed }">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Monthly Spending Trend</h3>
                            <div class="chart-wrapper">
                                <canvas ref="monthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Spending by Category</h3>
                            <div class="chart-wrapper">
                                <canvas ref="categoryPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container" style="margin-top: 2rem;">
                        <h3>Category Trends by Month</h3>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas ref="categoryByMonthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle" v-if="hasSections">
                <button :class="{ active: currentView === 'category' }" @click="currentView = 'category'">
                    By Category
                </button>
                <button :class="{ active: currentView === 'section' }" @click="currentView = 'section'">
                    By Section
                </button>
            </div>

            <!-- Section View -->
            <template v-if="currentView === 'section' && hasSections">
                <template v-for="(section, sectionId) in filteredSectionView" :key="sectionId">
                    <section class="category-section">
                        <div class="section-header" @click="toggleSection('sec:' + sectionId)">
                            <h2>
                                <span class="toggle">{{ collapsedSections.has('sec:' + sectionId) ? '‚ñ∂' : '‚ñº' }}</span>
                                {{ section.title }}
                            </h2>
                            <span class="section-total">
                                <span class="section-monthly">{{ formatCurrency(section.filteredTotal / numFilteredMonths) }}/mo</span> ¬∑
                                <span class="section-ytd">{{ formatCurrency(section.filteredTotal) }}</span>
                                <span class="section-pct">({{ formatPct(section.filteredTotal, grandTotal) }})</span>
                            </span>
                        </div>
                        <div class="section-content" :class="{ collapsed: collapsedSections.has('sec:' + sectionId) }">
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Merchant</th>
                                            <th>Subcategory</th>
                                            <th>Count</th>
                                            <th>Tags</th>
                                            <th>Total</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template v-for="(merchant, merchantId) in sortedMerchants(section.filteredMerchants)" :key="merchantId">
                                            <tr class="merchant-row"
                                                :class="{ expanded: expandedMerchants.has(merchantId) }"
                                                @click="toggleExpand(merchantId)">
                                                <td class="merchant clickable">
                                                    <span class="chevron">{{ expandedMerchants.has(merchantId) ? '‚ñº' : '‚ñ∂' }}</span>
                                                    <span @click.stop="addFilter(merchantId, 'merchant', merchant.displayName)">
                                                        {{ merchant.displayName }}
                                                    </span>
                                                </td>
                                                <td class="category clickable" @click.stop="addFilter(merchant.subcategory, 'category')">
                                                    {{ merchant.subcategory }}
                                                </td>
                                                <td>{{ merchant.filteredCount }}</td>
                                                <td class="tags-cell">
                                                    <span v-for="tag in (merchant.tags || [])"
                                                          :key="tag"
                                                          class="tag-badge"
                                                          @click.stop="addFilter(tag, 'tag')">{{ tag }}</span>
                                                </td>
                                                <td class="money">{{ formatCurrency(merchant.filteredTotal) }}</td>
                                                <td class="pct">{{ formatPct(merchant.filteredTotal, section.filteredTotal) }}</td>
                                            </tr>
                                            <tr v-for="txn in merchant.filteredTxns"
                                                :key="txn.id"
                                                class="txn-row"
                                                :class="{ hidden: !expandedMerchants.has(merchantId) }">
                                                <td colspan="6">
                                                    <div class="txn-detail">
                                                        <span class="txn-date">{{ formatDate(txn.date) }}</span>
                                                        <span v-if="txn.source" class="txn-source" :class="txn.source.toLowerCase()">{{ txn.source }}</span>
                                                        <span class="txn-desc">{{ txn.description }}</span>
                                                        <span class="txn-amount">{{ formatCurrency(txn.amount) }}</span>
                                                        <span class="txn-badge" :class="{ refund: txn.amount < 0 }">{{ txn.amount < 0 ? 'REFUND' : '' }}</span>
                                                        <span v-if="txn.location"
                                                              class="txn-location clickable"
                                                              :class="getLocationClass(txn.location)"
                                                              @click.stop="addFilter(txn.location, 'location')">
                                                            {{ txn.location }}
                                                        </span>
                                                        <span v-for="tag in (txn.tags || [])"
                                                              :key="tag"
                                                              class="tag-badge"
                                                              @click.stop="addFilter(tag, 'tag')">{{ tag }}</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                        <tr class="total-row">
                                            <td colspan="4">Total</td>
                                            <td class="money">{{ formatCurrency(section.filteredTotal) }}</td>
                                            <td class="pct">100%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </template>
            </template>

            <!-- Category View -->
            <template v-if="currentView === 'category'">
            <template v-for="(category, categoryName) in filteredCategoryView" :key="categoryName">
                    <section class="category-section">
                        <div class="section-header" @click="toggleSection('cat:' + categoryName)">
                            <h2>
                                <span class="toggle">{{ collapsedSections.has('cat:' + categoryName) ? '‚ñ∂' : '‚ñº' }}</span>
                                {{ categoryName }}
                            </h2>
                            <span class="section-total">
                                <span class="section-monthly">{{ formatCurrency(category.filteredTotal / numFilteredMonths) }}/mo</span> ¬∑
                                <span class="section-ytd">{{ formatCurrency(category.filteredTotal) }}</span>
                                <span class="section-pct">({{ formatPct(category.filteredTotal, grandTotal) }})</span>
                            </span>
                        </div>
                        <div class="section-content" :class="{ collapsed: collapsedSections.has('cat:' + categoryName) }">
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Merchant</th>
                                            <th>Subcategory</th>
                                            <th>Count</th>
                                            <th>Tags</th>
                                            <th>Total</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template v-for="(subcat, subcatName) in category.filteredSubcategories" :key="subcatName">
                                            <template v-for="(merchant, merchantId) in sortedMerchants(subcat.filteredMerchants)" :key="merchantId">
                                                <tr class="merchant-row"
                                                    :class="{ expanded: expandedMerchants.has(merchantId) }"
                                                    @click="toggleExpand(merchantId)">
                                                    <td class="merchant clickable">
                                                        <span class="chevron">{{ expandedMerchants.has(merchantId) ? '‚ñº' : '‚ñ∂' }}</span>
                                                        <span @click.stop="addFilter(merchantId, 'merchant', merchant.displayName)">
                                                            {{ merchant.displayName }}
                                                        </span>
                                                    </td>
                                                    <td class="category clickable" @click.stop="addFilter(subcatName, 'category')">
                                                        {{ subcatName }}
                                                    </td>
                                                    <td>{{ merchant.filteredCount }}</td>
                                                    <td class="tags-cell">
                                                        <span v-for="tag in (merchant.tags || [])"
                                                              :key="tag"
                                                              class="tag-badge"
                                                              @click.stop="addFilter(tag, 'tag')">{{ tag }}</span>
                                                    </td>
                                                    <td class="money">{{ formatCurrency(merchant.filteredTotal) }}</td>
                                                    <td class="pct">{{ formatPct(merchant.filteredTotal, category.filteredTotal) }}</td>
                                                </tr>
                                                <tr v-for="txn in merchant.filteredTxns"
                                                    :key="txn.id"
                                                    class="txn-row"
                                                    :class="{ hidden: !expandedMerchants.has(merchantId) }">
                                                    <td colspan="6">
                                                        <div class="txn-detail">
                                                            <span class="txn-date">{{ formatDate(txn.date) }}</span>
                                                            <span v-if="txn.source" class="txn-source" :class="txn.source.toLowerCase()">{{ txn.source }}</span>
                                                            <span class="txn-desc">{{ txn.description }}</span>
                                                            <span class="txn-amount">{{ formatCurrency(txn.amount) }}</span>
                                                            <span class="txn-badge" :class="{ refund: txn.amount < 0 }">{{ txn.amount < 0 ? 'REFUND' : '' }}</span>
                                                            <span v-if="txn.location"
                                                                  class="txn-location clickable"
                                                                  :class="getLocationClass(txn.location)"
                                                                  @click.stop="addFilter(txn.location, 'location')">
                                                                {{ txn.location }}
                                                            </span>
                                                            <span v-for="tag in (txn.tags || [])"
                                                                  :key="tag"
                                                                  class="tag-badge"
                                                                  @click.stop="addFilter(tag, 'tag')">{{ tag }}</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </template>
                                        <tr class="total-row">
                                            <td colspan="4">Total</td>
                                            <td class="money">{{ formatCurrency(category.filteredTotal) }}</td>
                                            <td class="pct">100%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </template>
            </template>

            <!-- Income Section -->
            <section class="income-section" v-if="incomeCount > 0">
                <div class="section-header" @click="showIncome = !showIncome">
                    <h2>
                        <span class="toggle">{{ showIncome ? '‚ñº' : '‚ñ∂' }}</span>
                        Income
                    </h2>
                    <span class="section-total">
                        <span class="section-ytd income-amount">+{{ formatCurrency(Math.abs(incomeTotal)) }}</span>
                        <span class="section-pct">({{ incomeCount }} transactions)</span>
                    </span>
                </div>
                <div class="section-content" v-show="showIncome">
                    <table>
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Category</th>
                                <th>Tags</th>
                                <th>Count</th>
                                <th class="money">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="(group, idx) in groupedIncome" :key="idx">
                                <tr class="merchant-row" @click="expandedIncome.has(idx) ? expandedIncome.delete(idx) : expandedIncome.add(idx)">
                                    <td>
                                        <span class="expand-arrow">{{ expandedIncome.has(idx) ? '‚ñº' : '‚ñ∂' }}</span>
                                        {{ group.merchant }}
                                    </td>
                                    <td class="category">{{ group.subcategory }}</td>
                                    <td class="tags-cell">
                                        <span v-for="tag in (group.tags || [])"
                                              :key="tag"
                                              class="tag-badge"
                                              @click.stop="addFilter(tag, 'tag')">{{ tag }}</span>
                                    </td>
                                    <td>{{ group.count }}</td>
                                    <td class="money income-amount">+{{ formatCurrency(Math.abs(group.total)) }}</td>
                                </tr>
                                <tr v-for="txn in group.transactions"
                                    :key="txn.id"
                                    class="txn-row"
                                    :class="{ hidden: !expandedIncome.has(idx) }">
                                    <td colspan="5">
                                        <div class="txn-detail">
                                            <span class="txn-date">{{ formatDate(txn.date) }}</span>
                                            <span class="txn-source" :class="txn.source.toLowerCase()">{{ txn.source }}</span>
                                            <span class="txn-desc">{{ txn.description }}</span>
                                            <span class="txn-amount income-amount">+{{ formatCurrency(Math.abs(txn.amount)) }}</span>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3">Total</td>
                                <td>{{ incomeCount }}</td>
                                <td class="money income-amount">+{{ formatCurrency(Math.abs(incomeTotal)) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <!-- Transfers Section -->
            <section class="transfers-section" v-if="transfersCount > 0">
                <div class="section-header" @click="showTransfers = !showTransfers">
                    <h2>
                        <span class="toggle">{{ showTransfers ? '‚ñº' : '‚ñ∂' }}</span>
                        Transfers
                    </h2>
                    <span class="section-total">
                        <span class="section-ytd">{{ formatCurrency(transfersTotal) }}</span>
                        <span class="section-pct">({{ transfersCount }} transactions)</span>
                    </span>
                </div>
                <div class="section-content" v-show="showTransfers">
                    <table>
                        <thead>
                            <tr>
                                <th>Destination</th>
                                <th>Category</th>
                                <th>Tags</th>
                                <th>Count</th>
                                <th class="money">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="(group, idx) in groupedTransfers" :key="idx">
                                <tr class="merchant-row" @click="expandedTransfers.has(idx) ? expandedTransfers.delete(idx) : expandedTransfers.add(idx)">
                                    <td>
                                        <span class="expand-arrow">{{ expandedTransfers.has(idx) ? '‚ñº' : '‚ñ∂' }}</span>
                                        {{ group.merchant }}
                                    </td>
                                    <td class="category">{{ group.subcategory }}</td>
                                    <td class="tags-cell">
                                        <span v-for="tag in (group.tags || [])"
                                              :key="tag"
                                              class="tag-badge"
                                              @click.stop="addFilter(tag, 'tag')">{{ tag }}</span>
                                    </td>
                                    <td>{{ group.count }}</td>
                                    <td class="money">{{ formatCurrency(group.total) }}</td>
                                </tr>
                                <tr v-for="txn in group.transactions"
                                    :key="txn.id"
                                    class="txn-row"
                                    :class="{ hidden: !expandedTransfers.has(idx) }">
                                    <td colspan="5">
                                        <div class="txn-detail">
                                            <span class="txn-date">{{ formatDate(txn.date) }}</span>
                                            <span class="txn-source" :class="txn.source.toLowerCase()">{{ txn.source }}</span>
                                            <span class="txn-desc">{{ txn.description }}</span>
                                            <span class="txn-amount">{{ formatCurrency(txn.amount) }}</span>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3">Total</td>
                                <td>{{ transfersCount }}</td>
                                <td class="money">{{ formatCurrency(transfersTotal) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <!-- Footer -->
            <footer>
                <p>Generated by tally &middot; Data through {{ spendingData.dataThrough || 'present' }}</p>
            </footer>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Data (injected by Python) -->
    <script>/* DATA_PLACEHOLDER */</script>

    <!-- Vue App -->
    <script>/* JS_PLACEHOLDER */</script>
</body>
</html>
